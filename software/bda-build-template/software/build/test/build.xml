<project name="test-run" default="run" basedir=".">
	<import file="test-common.xml" />
	<!-- -->
	<target name="test:init">
		<if>
			<not>
				<equals arg1="${java.specification.version}" arg2="1.5"/>
			</not>
			<then>
				<fail message="This test script requires JDK 1.5"/>
			</then>
		</if>
		<var name="svn.changed" unset="true"/>
		<groovy>                                 
			String cmd= "svn status -N .."
			println cmd                              
			process=cmd.execute()                    
			if (process.toString().length() > 0)
			{
			properties["svn.changed"]="true"
			}
		</groovy>                       
		<if>
			<isset property="svn.changed"/>
			<then>
				<echo message="WARNING ${build.dir} has changed files, commit them or changes may be lost because this process changes and reverts files."/>
				<!--
				<fail message="${build.dir} has changed files, commit them or changes may be lost because this process changes and reverts files."/>
				-->
			</then>
		</if>
			
	</target>
	<target name="test:jdk15" depends="test:init">
		<mkdir dir="${antunit.xml.report.dir}"/>
		<antunit failOnError="false" errorproperty="antunit-failure">
			<xmllistener toDir="${antunit.xml.report.dir}" logLevel="info" />
			<plainlistener logLevel="${screen.log.level}"/>
			<fileset dir="${basedir}/tests-jdk-1.5">
				<include name="test-suite*.xml"/>
			</fileset>
		</antunit>
	</target>
	<target name="test:suite:db" depends="test:init">
		<mkdir dir="${antunit.xml.report.dir}"/>
		<antunit failOnError="true">
			<file file="${basedir}/test-suite-db.xml" />
			<xmllistener toDir="${antunit.xml.report.dir}" logLevel="info" />
			<plainlistener logLevel="${screen.log.level}"/>
		</antunit>
	</target>
	<target name="test:suite:jboss:upgrade" depends="test:init">
		<mkdir dir="${antunit.xml.report.dir}"/>
		<antunit failOnError="true">
			<file file="${basedir}/test-suite-jboss-upgrade.xml" />
			<xmllistener toDir="${antunit.xml.report.dir}" logLevel="info" />
			<plainlistener logLevel="${screen.log.level}"/>
		</antunit>
	</target>
	<target name="test:suite:properties" depends="test:init">
		<mkdir dir="${antunit.xml.report.dir}"/>
		<antunit failOnError="true">
			<file file="${basedir}/test-suite-properties.xml" />
			<xmllistener toDir="${antunit.xml.report.dir}" logLevel="info" />
			<plainlistener logLevel="${screen.log.level}"/>
		</antunit>
	</target>

	<target name="report-tests">
		<junitreport>
			<fileset dir="${antunit.xml.report.dir}" includes="*.xml"/>
			<report format="frames" styledir="${antunit-style.dir}"
				todir="${antunit.html.report.dir}"/>
		</junitreport>
		<fail if="antunit-failure">At least one test has failed</fail>
	</target>
	<target name="run" depends="test:jdk15,setUp,report-tests">
	</target>
	<target name="temp:dac">
		<xmltask preservetype="true" source="${build.dir}/install.xml"
			dest="${build.dir}/install.xml"
			failWithoutMatch="true" >
			<xmlcatalog refid="bda.xml.catalog"/>
			<replace path="/project/target[@name='upgrade']/@depends" withtext="upgrade:common:init,common:init,upgrade-dac"/>
			<replace path="/project/target[@name='upgrade:tomcat']/@depends" withtext="upgrade:common:init,common:init,upgrade-dac:tomcat"/>
			<replace path="/project/target[@name='upgrade:jboss']/@depends" withtext="upgrade:common:init,common:init,upgrade-dac:jboss"/>
		</xmltask>              
	</target>
</project>
