<project name="tester" default="run" basedir=".">
	<property name="test.dir" location="."/>
	<dirname property="build.dir" file="${test.dir}"/>
	<dirname property="software.dir" file="${build.dir}"/>
	<property name="target.dir" location="${software.dir}/target"/>
	<property name="report.dir" location="${target.dir}/reports"/>
	<property name="bda-utils.dir" location="${target.dir}/bda-utils"/>
	<property name="common.dir" location="${software.dir}/common"/>
	<property name="antunit-style.dir" location="${common.dir}/antunit"/>
	<property name="antunit.xml.report.dir" location="${report.dir}/ant-unit-xml"/>
	<property name="antunit.html.report.dir" location="${report.dir}/ant-unit-html"/>
	<!-- to get bda.version -->
	<property file="${build.dir}/project.properties"/>

	<echo message="If it fails after this line 'cd ..; ant'"/>
	<import file="${bda-utils.dir}/bda-build-utils-${bda.version}.xml" />
	<!-- -->
	<path id="bda-utils.classpath">
		<fileset dir="${bda-utils.dir}">
			<include name="**/*.jar" />
		</fileset>
	</path>

	<taskdef resource="org/apache/ant/antunit/antlib.xml" classpathref="bda-utils.classpath" />

	<target name="run">
		<mkdir dir="${antunit.xml.report.dir}"/>
		<antunit failOnError="true">
			<file file="${basedir}/tester.xml" />
			<xmllistener toDir="${antunit.xml.report.dir}" logLevel="verbose" />
			<plainlistener logLevel="info"/>
		</antunit>
	</target>

	<target name="test:pass">
		<!-- clear the vars out from previous runs -->

		<ant inheritAll="false" inheritrefs="false"
			antfile="build.xml"
			dir="${build.dir}"
			target="build"
			>
		</ant>
	</target>
	<target name="test:fail" >
		<!-- clear the vars out from previous runs -->
		<var name="exec.out" unset="true"/>
		<var name="exec.err" unset="true"/>
		<var name="exec.rc" unset="true"/>
		<var name="try.property" unset="true"/>

		<trycatch property="try.property">
			<try>
				<ant inheritAll="false" inheritrefs="false"
					antfile="build.xml"
					dir="${build.dir}"
					target="junk:target"
					>
				</ant>
				<fail message="Should have failed"/>
			</try>
			<catch>
				<echo message="build failed as anticipated"/>
			</catch>
		</trycatch>
	</target>
	<target name="test:fail1">
		<!-- clear the vars out from previous runs -->
		<var name="exec.out" unset="true"/>
		<var name="exec.err" unset="true"/>
		<var name="exec.rc" unset="true"/>
		<var name="try.property" unset="true"/>

		<trycatch property="try.property">
			<try>
				<ant inheritAll="false" inheritrefs="false"
					antfile="build.xml"
					dir="${build.dir}"
					target="junk:target"
					>
				</ant>
				<fail message="Should have failed"/>
			</try>
			<catch>
				<echo message="build failed as anticipated"/>
			</catch>
		</trycatch>
	</target>
	<target name="report-tests">
		<junitreport>
			<fileset dir="${antunit.xml.report.dir}" includes="*.xml"/>
			<report format="frames" styledir="${antunit-style.dir}"
				todir="${antunit.html.report.dir}"/>
		</junitreport>
		<fail if="antunit-failure">At least one test has failed</fail>
	</target>
</project>
