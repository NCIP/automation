<?xml version="1.0" encoding="utf-8" ?>

<project name="bda-certification" default="build:project" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant" xmlns:cs="antlib:com.puppycrawl.tools.checkstyle">
	<description>
		This build file is part of the bda-build-template project.  This is the master build file for the project.  It should be placed in project/software/.  This script wrappers sub projects to build, test and inspect code.  Additionally this project manges creation of distributions and deployment locally or remotely.  Deployments will call the install.xml from the distribution to install or upgrade the application.  Lastly this script will run include targets that require manipulation of containers (selenium tests because they require starting the application server container (and require a fully deployed application which this process is responsible for). This build script assumes two sub-projects bda-blueprints-webapp and bda-blueprints-api. The API targets are commented out and can be removed if not needed.  Also support for both tomcat and jboss download, install and configure are included.  These scripts require Java, Ant, Database and SVN to work.
	</description>

	<property file="project.properties" />
	<property name="build.dir" location="${basedir}" />
	<property name="bda-download.dir" location="${build.dir}/bda-download" />
	<property name="lib.dir" location="${build.dir}/lib" />
	<property name="bda-utils.dir" location="${build.dir}/bda-utils" />
	<property name="log.dir" location="${build.dir}/logs" />
	
	<!-- retrive ivy files then retrieve bda files and librarires -->
	<property name="bda-download.file" value="bda-ivy-build.xml" />
	<mkdir dir="${bda-download.dir}" />
	<property name="bda-download.src.url" value="http://gforge.nci.nih.gov/svnroot/automation/trunk/software/bda-download/${bda-download.file}" />
	<get src="${bda-download.src.url}" dest="${bda-download.dir}/${bda-download.file}" />

	<ant inheritAll="false" inheritRefs="false" antfile="${bda-download.file}" target="retrieve-bda" dir="${bda-download.dir}">
		<property name="bda.version" value="${bda.version}" />
		<property name="bda-utils.dir" location="${bda-utils.dir}" />
		<property name="lib.dir" location="${lib.dir}" />
		<property name="software.dir" location="${build.dir}" />
	</ant>



	<!-- Paths -->
	<path id="bda-utils.classpath">
		<fileset dir="${bda-utils.dir}">
			<include name="**/*.jar" />
		</fileset>
	</path>
	<path id="ivy.classpath">
		<fileset dir="${lib.dir}">
			<include name="${ivy.file}" />
			<include name="${ivy-core.file}" />
		</fileset>
	</path>
	
	<taskdef resource="org/apache/ivy/ant/antlib.xml" uri="antlib:org.apache.ivy.ant" classpathref="ivy.classpath" />
	<taskdef name="for" classname="net.sf.antcontrib.logic.ForTask">
		<classpath>
			<pathelement location="${bda-utils.dir}/ant-contrib-1.0b3.jar" />
		</classpath>
	</taskdef>

	<!-- Includes- include BDA marcos -->
	<import file="${bda-utils.dir}/bda-build-utils-${bda.version}.xml" />

	<!-- Start logging -->
	<mkdir dir="${log.dir}" />
	<tstamp>
		<format property="install.time" pattern="yyyy-MM-dd-HH-mm" />
	</tstamp>
	<record name="${log.dir}/install-${install.time}.log" action="start" />


	<path id="jdbc.driver.classpath">
		<pathelement location="${database.driver.file}"/>
	</path>


	<!-- Targets -->


	<target name="init" description="Sets up build are and initalizes variables">

	<!-- set some db variables -->
	<propertycopy name="project.database.type" from="${project.name}.database.type" />
	<switch value="${project.database.type}">
		<case value="oracle">
			<property name="database.dialect" value="org.hibernate.dialect.OracleDialect"/>
			<property name="database.driver.file" value="${bda-utils.dir}/ojdbc14-10.2.0.3.0.jar"/>
			<property name="database.driver" value="oracle.jdbc.driver.OracleDriver"/>
			<property name="db-upgrade.list.file" value="${db-upgrade.oracle.list.file}"/>
			<property name="db-upgrade.conf.file" value="${db-upgrade.oracle.conf.file}"/>
			<property name="database.schema" value="${database.name}"/>
		</case>
		<case value="mysql">
			<property name="database.dialect" value="org.hibernate.dialect.MySQLDialect"/>
			<property name="database.driver.file" value="${bda-utils.dir}/mysql-connector-java-5.0.5.jar"/>
			<property name="database.driver" value="com.mysql.jdbc.Driver"/>
			<property name="db-upgrade.list.file" value="${db-upgrade.mysql.list.file}"/>
			<property name="db-upgrade.conf.file" value="${db-upgrade.mysql.conf.file}"/>
			<property name="database.schema" value="${database.name}"/>
		</case>
		<case value="postgresql">
			<property name="database.dialect" value="org.hibernate.dialect.PostgreSQLDialect"/>
			<property name="database.driver.file" value="${bda-utils.dir}/postgresql-jdbc3-8.3-603.jar"/>
			<property name="database.driver" value="org.postgresql.Driver"/>
			<property name="db-upgrade.list.file" value="${db-upgrade.postgresql.list.file}"/>
			<property name="db-upgrade.conf.file" value="${db-upgrade.postgresql.conf.file}"/>
			<property name="database.schema" value="public"/>
		</case>
		<default>
			<fail message="Invalid database type ${database.type}"/>
		</default>
	</switch>


	</target>

	<target name="build:project" depends="init,build:single-command-build" description="Sets up build are and initalizes variables">
		<echo message="call build:project target.. "/>
	</target>
	
	<target name="validate:JAD" depends="init" description="Runs pre-install validation checks bda-utils">		
		<propertycopy name="project.database.url" from="${project.name}.database.url" />
		<propertycopy name="project.database.system.url" from="${project.name}.database.system.url" />


		<validate-environment
			ant.check.version="${ant.minimum.version}"
			java.check.version.major="${java.major.version}"
			java.check.version.minor="${java.minor.version}"		
			/>
	
		<database-create
			database.driver="${database.driver}"
			database.system.url="${project.database.system.url}"
			database.system.user="${database.system.user}"
			database.system.password="${database.system.password}"
			database.url="${project.database.url}"
			database.user="${database.user}"
			database.password="${database.password}"
			database.version="${database.version}"
			database.name="${database.name}"
			/>

		<validate-database
			database.driver="${database.driver}"
			database.system.url="${project.database.system.url}"
			database.system.user="${database.system.user}"
			database.system.password="${database.system.password}"
			database.url="${project.database.url}"
			database.user="${database.user}"
			database.password="${database.password}"
			database.version="${database.version}"
			database.name="${database.name}"
			/>
	</target>

	
	<target name="validate:svn:checkout-project" depends="init,svn:scorch,svn:init">
		<propertycopy name="project.svn.username" from="${project.name}.svn.username" />
		<propertycopy name="project.svn.password" from="${project.name}.svn.password" />
		<propertycopy name="project.svn.project.url" from="${project.name}.svn.project.url" />
		<propertycopy name="project.svn.local.checkout" from="${project.name}.svn.local.checkout" />

		<svn username="${project.svn.username}" password="${project.svn.password}">
			<checkout url="${project.svn.project.url}" revision="HEAD" destPath="${project.svn.local.checkout}" />
		</svn>
	</target>
	
	<target name="svn:scorch">
		<echo message="Scorching local SVN working directory ${project.svn.local.checkout}..." />
		<delete dir="${project.svn.local.checkout}" />
	</target>
	
	<target name="svn:init">
		<delete dir="working"/>
		<mkdir dir="working"/>
	</target>
	
	<target name="build:single-command-build" depends="init">
		<propertycopy name="project.master.build.location" from="${project.name}.master.build.location" />
		<propertycopy name="project.single-command.build.target" from="${project.name}.single-command.build.target" />
		<propertycopy name="project.master.build.file" from="${project.name}.master.build.file" />

		<ant inheritAll="false" inheritRefs="false" antfile="${project.master.build.file}" target="${project.single-command.build.target}" dir="${project.master.build.location}"/>		
	</target>

	<target name="build:single-command-deployment" depends="init">
		<propertycopy name="project.master.build.location" from="${project.name}.master.build.location" />
		<propertycopy name="project.single-command.deployment.target" from="${project.name}.single-command.deployment.target" />
		<propertycopy name="project.master.build.file" from="${project.name}.master.build.file" />

		<ant inheritAll="false" inheritRefs="false" antfile="${project.master.build.file}" target="${project.single-command.deployment.target}" dir="${project.master.build.location}"/>
<!--		
		<ant inheritAll="false" inheritRefs="false" antfile="${project.master.build.file}" target="install" dir="${project.master.build.location}/../target/dist/exploded">
			<property name="-Dproperties.file" value="install.properties" />			
			<property name="-Dforce.reinstall" value="true" />
			<property name="database.system.user" value="root"/>
			<property name="database.system.password" value="mysql"/>
			<property name="database.server" value="${database.server}"/>
			<property name="database.port" value="${database.port}"/>
			<property name="database.name" value="${database.name}"/>
			<property name="database.user" value="${database.user}"/>
			<property name="database.password" value="${database.password}"/>			
		</ant>

-->
		<copy file="${build.dir}/../hibernate.cfg.xml" todir="${project.master.build.location}/../target/dist/exploded"/>


		<exec osfamily="unix" executable="ant" dir="${project.master.build.location}/../target/dist/exploded" failonerror="true">			
			<arg value="-Dproperties.file=install.properties" />			
			<arg value="-Dforce.reinstall=true" />
			<arg value="-Ddatabase.system.user=${database.system.user}" />
			<arg value="-Ddatabase.system.password=${database.system.password}" />
			<arg value="-Ddatabase.server=${database.server}" />
			<arg value="-Ddatabase.port=${database.port}" />
			<arg value="-Ddatabase.name=${database.name}" />
			<arg value="-Ddatabase.user=${database.user}" />
			<arg value="-Ddatabase.password=${database.password}" />
			<arg value="-Dexecuted.target.name=install" />
			<arg value="-Dmap.name=singleCommandDeployment" />			
			<arg value="-Dproject.name=${project.name}" />
			<arg value="-listener" />
			<arg value="gov.nih.nci.bda.certification.listener.SingleCommandListener" />
			<arg value="-lib" />
			<arg value="${build.dir}/.." />
			<arg value="install" />
		</exec>
		<exec osfamily="windows" executable="ant.bat" dir="${project.master.build.location}/../target/dist/exploded" failonerror="true">			
			<arg value="-Dproperties.file=install.properties" />			
			<arg value="-Dforce.reinstall=true" />
			<arg value="-Ddatabase.system.user=${database.system.user}" />
			<arg value="-Ddatabase.system.password=${database.system.password}" />
			<arg value="-Ddatabase.server=${database.server}" />
			<arg value="-Ddatabase.port=${database.port}" />
			<arg value="-Ddatabase.name=${database.name}" />
			<arg value="-Ddatabase.user=${database.user}" />
			<arg value="-Ddatabase.password=${database.password}" />
			<arg value="-Dexecuted.target.name=install" />
			<arg value="-Dmap.name=singleCommandDeployment" />			
			<arg value="-Dproject.name=${project.name}" />
			<arg value="-listener" />
			<arg value="gov.nih.nci.bda.certification.listener.SingleCommandListener" />
			<arg value="-lib" />
			<arg value="${build.dir}/.." />
			<arg value="install" />
		</exec>

	</target>

	<target name="build:database-integration" depends="init">
		<propertycopy name="project.master.build.location" from="${project.name}.master.build.location" />
		<propertycopy name="project.database.integration.target" from="${project.name}.database.integration.target" />
		<propertycopy name="project.database.type" from="${project.name}.database.type" />
		<groovy>
			<arg line="${project.master.build.location}"/>
			<arg line="${project.database.integration.target}"/>
			<arg line="${project.database.type}"/>
			def buildFileLocation=args[0]
			def targetName=args[1]
			def databaseType=args[2]
			
			def ant = new AntBuilder()						
			String installPropertiesFile=new File(buildFileLocation+"/install.properties").getAbsoluteFile();			
			Properties props = new Properties();
			props.load(new FileInputStream(installPropertiesFile));			
			String dbFlag = props.getProperty("exclude.database");
			println dbFlag;
			println databaseType;
			if(dbFlag != null)
			{
				println "Flag is set skip DB integration Check"
			}
			else
			{
				println "DB integration Check"
				installFile = new File(buildFileLocation+"/install.xml").getAbsoluteFile()
				project = new XmlParser().parse(installFile)				
				println project.target.'@name'.contains(targetName)
				if(project.target.'@name'.contains(targetName))
				{
					if(project.target.find{it.'@name'=='install'}.'@depends'.contains(targetName))
					{
						def targetUpgrade = project.target.find{it.@name==targetName}.'database-upgrade'
						if(!targetUpgrade)
							ant.fail("DATABASE INTEGRATION FAILED: The database-upgrade target is missing")
							
						def targetInstall = project.'target'.find{it.@name==targetName}.switch.'case'.find{it.'@value'==databaseType}.'database-install'
						if(!targetInstall)
							ant.fail("DATABASE INTEGRATION FAILED: The database-install target is missing")
						
						println "CHECK FOR MACROS COMPLETE"
					}
					else
					{				
						ant.fail("DATABASE INTEGRATION FAILED: The install:database target is not called from the install target")
					}
				}
				else
				{				
					ant.fail("DATABASE INTEGRATION FAILED: The install:database target is not found in the install.xml")
				}
				
			}	
		</groovy>
	</target>

</project>
